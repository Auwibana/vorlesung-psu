%*****************************************************************************
%** beamer setup  **************************************************************

\usecolortheme{rose}
\usetheme[wide=true]{sra}
\setbeamertemplate{navigation symbols}{}

\usepackage[physicalpagesinpdftoc,sracolors,autonotes]{beamertools}


\usepackage{pageslts} %  theCurrentPage
\usepackage{calc} % theCurrentPage
\usepackage{csquotes}
\usepackage{booktabs}
\usepackage{xspace}
\usepackage{multirow}

% Section Title and Block Number
\newcommand{\psuSectionStart}[2]{
  \ifdefstring{\psuOldTitle}{#1}
  {}% Then
  {\section{#1}}%
  \def\psuOldTitle{#1}
}


\newwrite\cutfile
\immediate\openout\cutfile=\jobname.topics
\newcounter{FirstPage} % counter, for first page number
\newcounter{EndPage} % counter, for first page number
\setcounter{FirstPage}{1} % Set FirstPage to page 1
\newcommand{\psuSectionStop}[2]{% {topic}{lines}
  \setcounter{EndPage}{\theCurrentPage-1}
  \immediate\write\cutfile{\theFirstPage -\theEndPage:#2:#1}%
  \setcounter{FirstPage}{\theCurrentPage}% set FirstPage to new first page
}


\AtBeginDocument{
  \pagenumbering{arabic} % for pageslts
  \SetPartNumToFileNum
}



  % Name, token and semester of the course
  \def\xtoken{PSÜ}
  \def\xtitle{Programmiersprachen und Übersetzer (PSÜ)}%
  \def\xterm{SS}
  \def\xyear{20}

  % General organization of the course
  \def\PartA{Einführung}
  \def\PartB{Prozesse und Dateien}
  \def\PartC{Interaktion und Kommunikation}
  \def\PartD{Speicher und Zugriffsschutz}
  \def\PartX{Anhang}

  \institute[SRA]{Institute for Systems Engineering\\System- und Rechnerarchitektur (SRA)}
  \author[\copyright\,cd]{Christian Dietrich}

  \def\termurl{\url{https://sra.uni-hannover.de/Lehre/\xterm\xyear/V_\xtoken}}
  \edef\term{\xterm\, \xyear}
  \def\auxWS{Wintersemester}
  \def\auxSS{Sommersemester}
  \edef\TERM{\csuse{aux\xterm} 20\xyear}

  \def\xshortdate{\ifx\insertpart\empty\term{}\else Teil~\thepart, \term{}\fi}
  \date[\xshortdate]{\TERM}

  \title[\xtoken]{\xtitle}

  % Parse job name <number>-<rest>.tex into \fileNumber=<number> and \fileName=<rest>.tex and
  % set the part-counter so that the first section will be <number>
  \newcommand{\SetPartNumToFileNum}{
    \def\retrieveFileName##1-##2\next{\gdef\fileNumber{##1 \relax}\gdef\fileName{##2 \relax}}
    \expandafter \retrieveFileName\jobname\next\relax
    % -1, as the \section command first advances the counter
    \setcounter{part}{\fileNumber}
  }
  % Customize numbering:
  % We want to number frames as <chapter>-<frame> with <frame> being by-chapter numbers
  % Note: The following works only if a patch is applied to beamerbaseframe.sty (see README)
  \renewcommand{\theframenumber}{\thepart--\arabic{framenumber}}
  \renewcommand{\insertframenumber}{\theframenumber}
  \renewcommand{\InsertFrameNumber}{\insertframenumber}


  \newcommand{\animation}[3][]{%
  \foreach \p/\s in {#2} {%
    \includegraphics<\s|handout:\s>[page=\p,#1]{#3}%
  }%
}


%*****************************************************************************
%** bibliography *************************************************************

\usepackage[style=numeric-comp,hyperref,maxnames=3,minnames=3,defernums=true, backend=bibtex8]{biblatex}
\defbibheading{bibliography}{}
\bibliography{refs,bib/sra-ext}
\renewcommand{\bibfont}{\scriptsize}
\DeclareFieldFormat{postnote}{#1}



%****************************************************************
%** tikz stuff
\usepackage{tikz}
\usetikzlibrary{tikzmark,arrows,fit,calc,positioning}
\usepackage{pgfkeys}
\tikzset{
  small tree/.style={
    every node/.append style={
      font=\footnotesize,
      draw,
    },
    level distance=1cm,
  }
}

%*****************************************************************************
%** Legalcode *************************************************************

\pgfkeys{
  /legalcode/commons/.style={url={https://commons.wikimedia.org/wiki/File:#1}},
  /legalcode/url/.code={%
    \def\lcText##1{\href{#1}{##1}}
  },
  /legalcode/author/.code={\def\lcAuthor{, #1}},
  /legalcode/license/CC BY-SA 3.0/.code={%
    \def\lcLicense{\href{https://creativecommons.org/licenses/by-sa/3.0/legalcode}{CC BY-SA 3.0}}%
  },
  /legalcode/license/Free Art License/.code={%
    \def\lcLicense{Free Art License}%
  }
}
\newcommand{\legalcode}[3][]{% [opts]{license}{title}
  \bgroup%
  \def\lcText##1{##1}
  \def\lcAuthor{}
  \pgfkeys{/legalcode/.cd,#1,license/#2}%
  \parbox{\textwidth}{\centering\color{gray}\tiny\lcText{#3}\lcAuthor{} \mbox{(\lcLicense)}}
  \egroup
}

%*****************************************************************************
%** code blocks **************************************************************

  \makeatletter
  \setbeamercolor{code}{fg=black,bg=luhlightgray!50}

  \define@key{beamercolbox}{text width}{\pgfmathsetlengthmacro{\beamer@colbox@wd}{#1}}
  \define@key{beamercolbox}{text height}{\pgfmathsetlengthmacro{\beamer@colbox@ht}{#1}}
  \define@key{beamercolbox}{text depth}{\pgfmathsetlengthmacro{\beamer@colbox@dp}{#1}}
  \define@key{beamercolbox}{background color}{\setbeamercolor{code}{fg=black,bg=#1}}
  \define@key{beamercolbox}{scale content}{\def\bt@innerscale{#1}}
  \define@key{beamercolbox}{tag}{\def\bt@tag{#1}}

  \newenvironment<>{code}[1][\empty]{%
    \begin{onlyenv}#2%
    \vspace{2pt}%
    \setkeys{beamercolbox}{#1}
    \lstset{aboveskip=0pt,belowskip=0pt,linewidth=\beamer@colbox@wd}%
    \rule{2pt}{0pt}\begin{beamercolorbox}[colsep*=2pt,text width=\linewidth-4pt, text depth=0ex,#1]{code}%
    \ifdef\bt@innerscale{%
      \pgfmathsetlength{\@tempdima}{\beamer@colbox@wd/\bt@innerscale}
      \begin{adjustbox}{scale=\bt@innerscale}
      \begin{minipage}{\@tempdima}
        \lstset{linewidth=\@tempdima}%
      }{}
  }{%
    \ifcsdef{bt@tag}{%
      \vspace{-1.2\baselineskip}\hfill{\emph{\color{black!70!white}\csuse{bt@tag}}}
      \vspace{0.4\baselineskip}
    }{}%
    \ifdef\bt@innerscale{%
      \end{minipage}
      \end{adjustbox}
    }{}%
    \end{beamercolorbox}\rule{2pt}{0pt}\vspace{2pt}%
    \end{onlyenv}%
    \ignorespacesafterend%
  }

  \lstdefinelanguage[riscv]{Assembler}{
    morestring=[b]",
    morekeywords=[1]{bne, beq, blt, bltu, bge, bgeu, jal, jalr, auipc, lb, lh, lw, ld, lbu, lhu, lwu, sb, sh, sw, sd, amoadd_w, amoxor_w, amoswap_w, amoand_w, amoor_w, amomin_w, amominu_w, amomax_w, amomaxu_w, amoadd_d, amoswap_d, amoxor_d, amoand_d, amoor_d, amomin_d, amominu_d, amomax_d, amomaxu_d, lr_w, lr_d, sc_w, sc_d, lui, addi, slti , sltiu, andi, ori, xori, slli, srli, srai, add, sub, slt, sltu, and, or, xor, sll, srl, sra, addiw, slliw, srliw, sraiw, addw, subw, sllw, srlw, sraw, mul, mulh, mulhu, mulhsu, mulw, div, divu, rem, remu, divw, divuw, remw, remuw, fence, fence_i, sfence_vm, scall, sbreak, sret, mrts, wfi, csrrw, csrrs, csrrc, csrrwi, csrrsi, csrrci
    }
    comment=[l]\#%
  }[keywords,comments,strings]

\lstdefinelanguage{lzero}{
  morestring=[b]",
  morekeywords=[1]{if,while,return,func,int,var,decl},
  comment=[l]{//}%
}[keywords,comments,strings]


  \lstloadlanguages{C,C++,Java,sh,[x86masm]Assembler}
  \lstdefinestyle{basestyle}{
    basicstyle=\footnotesize\ttfamily,
    keywordstyle=\color{luhblue},
    commentstyle=\color{badbee!70!black},
    showstringspaces=false,
    breaklines=false,
    mathescape=true,
    lineskip=-2pt,
    escapechar={§},
    numbersep=1.5em,
    numberstyle=\tiny,
    showlines
  }
  \lstdefinestyle{smaller}{%
    basicstyle=\scriptsize\ttfamily,
  }
  \lstdefinestyle{C}{
    style=basestyle,
    language={C},
    morekeywords={inline},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{ASM}{
    style=basestyle,
		mathescape=false,
    language={[riscv]Assembler},
		keywords={.macro, .endm},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{CPP}{
    style=basestyle,
    language={C++},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{py}{
    style=basestyle,
    language={python},
    includerangemarker=false,
    rangeprefix={\#},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{text}{
    style=basestyle,
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{lzero}{
    style=basestyle,
    language={lzero},
    includerangemarker=false,
    rangeprefix={//},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{Java}{
    style=basestyle,
    language={Java},
    moredelim=**[is][\bfseries]{'}{'},
    moredelim=**[is][\slshape]{''}{''},
    moredelim=**[is][\lsthighlight]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{i4blue}]{@@@}{@@@},
  }

\let\C=\relax

\lstnewenvironment{C}[1][]{
  \lstset{style=C, autogobble, #1}
} {}

\lstnewenvironment{stdout}[1][]{
  \lstset{style=text, autogobble, #1}
} {}

\lstnewenvironment{CPP}[1][]{
  \lstset{style=CPP, autogobble, #1}
} {}
\lstnewenvironment{py}[1][]{
  \lstset{style=py, autogobble, #1}
} {}
\lstnewenvironment{lzero}[1][]{
  \lstset{style=lzero, autogobble, #1}
} {}
\lstnewenvironment{asm}[1][]{
  \lstset{style=ASM, autogobble, #1}
} {}

  % set default for \lstinline
  \lstset{style=C, basicstyle=\scriptsize\ttfamily, keywordstyle={}}

  \lstdefinestyle{highlighting}{
    style=nohighlighting,
    moredelim=**[is][\btHL<1>]{@1}{@},
    moredelim=**[is][\btHL<2>]{@2}{@},
    moredelim=**[is][\btHL<3>]{@3}{@},
    moredelim=**[is][\btHL<4>]{@4}{@},
    moredelim=**[is][\btHL<5>]{@5}{@},
    moredelim=**[is][\btHL<6>]{@6}{@},
    moredelim=**[is][\btHL<7>]{@7}{@},
    moredelim=**[is][\btHL<8>]{@8}{@},
    moredelim=**[is][\btHL<9>]{@9}{@},
 }
  \lstdefinestyle{nohighlighting}{
    moredelim=**[is][]{@1}{@},
    moredelim=**[is][]{@2}{@},
    moredelim=**[is][]{@3}{@},
    moredelim=**[is][]{@4}{@},
    moredelim=**[is][]{@5}{@},
    moredelim=**[is][]{@6}{@},
    moredelim=**[is][]{@7}{@},
    moredelim=**[is][]{@8}{@},
    moredelim=**[is][]{@9}{@},
  }
  \lstdefinestyle{highlight1}{
    style=nohighlighting,
    moredelim=**[is][\btHL]{@1}{@},
  }
  \lstdefinestyle{highlight2}{
    style=nohighlighting,
    moredelim=**[is][\btHL]{@2}{@},
  }
  \lstdefinestyle{highlight3}{
    style=nohighlighting,
    moredelim=**[is][\btHL]{@3}{@},
  }
  \lstdefinestyle{highlight4}{
    style=nohighlighting,
    moredelim=**[is][\btHL]{@4}{@},
  }
  \lstdefinestyle{highlight5}{
    style=nohighlighting,
    moredelim=**[is][\btHL]{@5}{@},
  }
  \lstdefinestyle{highlight6}{
    style=nohighlighting,
    moredelim=**[is][\btHL]{@6}{@},
  }
  \lstdefinestyle{highlight7}{
    style=nohighlighting,
    moredelim=**[is][\btHL]{@7}{@},
  }


  % Makros to underbrace/overbrace elements in listings
  %
  % \lstub<overlay spec>{stuff}{brace comment}
  % \lstob<overlay spec>{stuff}{brace comment}
  %
  %
  \newcommand<>{\lstub}[2]{\ensuremath{%
    \underset{%
      \onslide#3{\text{#1}}
    }{%
      {\only#3\underbrace{
        \text{#2}
      }}
    }
  }}
  \newcommand<>{\lstob}[2]{\ensuremath{%
    \overset{%
      \onslide#3{\text{#1}}
    }{%
      {\only#3\overbrace{
        \text{#2}
      }}
    }
  }}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Misc
\usepackage{convention} % texmf-local
\newcommand{\advantage}[1]{\bgroup\color{safegreen}#1{\egroup}}
\newcommand{\dn}[2][]{\tikz[baseline]\node[anchor=base,circle,inner sep=1pt,draw,#1]{#2};}
\renewcommand{\iiad}{\ii[\color{safegreen}\textbf{+}]}  % advantage
\renewcommand{\iida}{\ii[\color{safered}\textbf{--}]} % disadvantage
\newcommand{\lecturetag}[3][]{%
  \tikz[baseline]\node[anchor=base,draw=black,fill=#2color,#1]{\color{black}Vorlesung #3};
}

\newcommand{\dividerframe}[1]{
  \begin{frame}<handout:0>[noframenumbering]
    \begin{center}
      \Huge #1
    \end{center}
  \end{frame}
}
\newcommand{\signature}[4][sig]{%
  \begin{center}\ttfamily
    \tikz[remember picture,baseline]\node[anchor=base](#1-name){#2};%
    ::%
    \tikz[remember picture,baseline]\node[anchor=base](#1-input){#3};
    $\longrightarrow$%
    \tikz[remember picture,baseline]\node[anchor=base](#1-output){#4};
  \end{center}
}

\newenvironment{indentbox}[2][]%
{\vspace{2pt}\begingroup\def\bt@identbox@indent{#2}%
  \tikzset{bt@identbox/.style={#1}}\begin{lrbox}{\@tempboxa}%
 \begin{minipage}{\linewidth-\bt@identbox@indent-8pt}%
}{%
  \end{minipage}\end{lrbox}%
  \hspace{\bt@identbox@indent}\tikz\node[draw,inner sep=2pt,bt@identbox]{\strut\usebox{\@tempboxa}};%
  \endgroup%
}
