%*****************************************************************************
%** beamer setup  **************************************************************

\usecolortheme{rose}
\usetheme[wide=true]{sra}
\setbeamertemplate{navigation symbols}{}

\usepackage[physicalpagesinpdftoc,sracolors,autonotes]{beamertools}


\usepackage{pageslts} %  theCurrentPage
\usepackage{calc} % theCurrentPage
\usepackage{csquotes}
\usepackage{booktabs}
\usepackage{xspace}
\usepackage{multirow}
\usepackage{pgffor}

% Section Title and Block Number
\newcommand{\psuSectionStart}[2]{
  \ifdefstring{\psuOldTitle}{#1}
  {}% Then
  {\section{#1}}%
  \def\psuOldTitle{#1}
}


\newwrite\cutfile
\immediate\openout\cutfile=\jobname.topics
\newcounter{FirstPage} % counter, for first page number
\newcounter{EndPage} % counter, for first page number
\setcounter{FirstPage}{1} % Set FirstPage to page 1
\newcommand{\psuSectionStop}[2]{% {topic}{lines}
  \setcounter{EndPage}{\theCurrentPage-1}
  \immediate\write\cutfile{\theFirstPage -\theEndPage:#2:#1}%
  \setcounter{FirstPage}{\theCurrentPage}% set FirstPage to new first page
}


\AtBeginDocument{
  \pagenumbering{arabic} % for pageslts
  \SetPartNumToFileNum
}



  % Name, token and semester of the course
  \def\xtoken{PSÜ}
  \def\xtitle{Programmiersprachen und Übersetzer (PSÜ)}%
  \def\xterm{SS}
  \def\xyear{20}

  % General organization of the course
  \def\PartA{Einführung}
  \def\PartB{Prozesse und Dateien}
  \def\PartC{Interaktion und Kommunikation}
  \def\PartD{Speicher und Zugriffsschutz}
  \def\PartX{Anhang}

  \institute[SRA]{Institute for Systems Engineering\\System- und Rechnerarchitektur (SRA)}
  \author[\copyright\,cd]{Christian Dietrich}

  \def\termurl{\url{https://sra.uni-hannover.de/Lehre/\xterm\xyear/V_\xtoken}}
  \edef\term{\xterm\, \xyear}
  \def\auxWS{Wintersemester}
  \def\auxSS{Sommersemester}
  \edef\TERM{\csuse{aux\xterm} 20\xyear}

  \def\xshortdate{\ifx\insertpart\empty\term{}\else Teil~\thepart, \term{}\fi}
  \date[\xshortdate]{\TERM}

  \title[\xtoken]{\xtitle}

  % Parse job name <number>-<rest>.tex into \fileNumber=<number> and \fileName=<rest>.tex and
  % set the part-counter so that the first section will be <number>
  \newcommand{\SetPartNumToFileNum}{
    \def\retrieveFileName##1-##2\next{\gdef\fileNumber{##1 \relax}\gdef\fileName{##2 \relax}}
    \expandafter \retrieveFileName\jobname\next\relax
    % -1, as the \section command first advances the counter
    \setcounter{part}{\fileNumber}
  }
  % Customize numbering:
  % We want to number frames as <chapter>-<frame> with <frame> being by-chapter numbers
  % Note: The following works only if a patch is applied to beamerbaseframe.sty (see README)
  \renewcommand{\theframenumber}{\thepart--\arabic{framenumber}}
  \renewcommand{\insertframenumber}{\theframenumber}
  \renewcommand{\InsertFrameNumber}{\insertframenumber}


  \newcommand{\animation}[3][]{%
  \foreach \p/\s in {#2} {%
    \includegraphics<\s|handout:\s|skript:\s>[page=\p,#1]{#3}%
  }%
}


%*****************************************************************************
%** bibliography *************************************************************

\usepackage[style=numeric-comp,hyperref,maxnames=3,minnames=3,defernums=true, backend=bibtex8]{biblatex}
\defbibheading{bibliography}{}
\bibliography{refs,bib/sra-ext}
\renewcommand{\bibfont}{\scriptsize}
\DeclareFieldFormat{postnote}{#1}



%****************************************************************
%** tikz stuff
\usepackage{tikz}
\usetikzlibrary{tikzmark,arrows,fit,calc,positioning,sra}
\usepackage{pgfkeys}
\tikzset{
  >=latex',
  small tree/.style={
    every node/.append style={
      font=\footnotesize,
      draw,
    },
    level distance=1cm,
  }
}

%*****************************************************************************
%** Legalcode *************************************************************

\pgfkeys{
  /legalcode/commons/.style={url={https://commons.wikimedia.org/wiki/File:#1}},
  /legalcode/url/.code={%
    \def\lcText##1{\href{#1}{##1}}
  },
  /legalcode/author/.code={\def\lcAuthor{, #1}},
  /legalcode/license/CC BY-SA 3.0/.code={%
    \def\lcLicense{\href{https://creativecommons.org/licenses/by-sa/3.0/legalcode}{CC BY-SA 3.0}}%
  },
  /legalcode/license/Free Art License/.code={%
    \def\lcLicense{Free Art License}%
  }
}
\newcommand{\legalcode}[3][]{% [opts]{license}{title}
  \bgroup%
  \def\lcText##1{##1}
  \def\lcAuthor{}
  \pgfkeys{/legalcode/.cd,#1,license/#2}%
  \parbox{\textwidth}{\centering\color{gray}\tiny\lcText{#3}\lcAuthor{} \mbox{(\lcLicense)}}
  \egroup
}

%*****************************************************************************
%** code blocks **************************************************************

  \makeatletter
  \setbeamercolor{code}{fg=black,bg=codecolor}

  \define@key{beamercolbox}{text width}{\pgfmathsetlengthmacro{\beamer@colbox@wd}{#1}}
  \define@key{beamercolbox}{text height}{\pgfmathsetlengthmacro{\beamer@colbox@ht}{#1}}
  \define@key{beamercolbox}{text depth}{\pgfmathsetlengthmacro{\beamer@colbox@dp}{#1}}
  \define@key{beamercolbox}{background color}{\setbeamercolor{code}{fg=black,bg=#1}}
  \define@key{beamercolbox}{scale content}{\def\bt@innerscale{#1}}
  \define@key{beamercolbox}{tag}{\def\bt@tag{#1}}

  \newenvironment<>{code}[1][\empty]{%
    \begin{onlyenv}#2%
    \vspace{2pt}%
    \setkeys{beamercolbox}{#1}
    \lstset{aboveskip=0pt,belowskip=0pt,linewidth=\beamer@colbox@wd}%
    \rule{2pt}{0pt}\begin{beamercolorbox}[colsep*=2pt,text width=\linewidth-4pt, text depth=0ex,#1]{code}%
    \ifdef\bt@innerscale{%
      \pgfmathsetlength{\@tempdima}{\beamer@colbox@wd/\bt@innerscale}
      \begin{adjustbox}{scale=\bt@innerscale}
      \begin{minipage}{\@tempdima}
        \lstset{linewidth=\@tempdima}%
      }{}
  }{%
    \ifcsdef{bt@tag}{%
      \vspace{-1.2\baselineskip}\hfill{\emph{\color{black!70!white}\csuse{bt@tag}}}
      \vspace{0.4\baselineskip}
    }{}%
    \ifdef\bt@innerscale{%
      \end{minipage}
      \end{adjustbox}
    }{}%
    \end{beamercolorbox}\rule{2pt}{0pt}\vspace{2pt}%
    \end{onlyenv}%
    \ignorespacesafterend%
  }

  \usepackage{xparse}
  \usepackage{realboxes}
  \DeclareDocumentCommand{\codebox}{O{codecolor}m}{\Colorbox{#1}{\texttt #2}}
  \DeclareDocumentCommand{\codeinline}{D<>{1-}O{}v}{%
    \only<#1>{%
      \Colorbox{codecolor}{\csname lstinline\endcsname[#2]!#3!}%
    }%
  }

  \lstdefinelanguage[riscv]{Assembler}{
    morestring=[b]",
    morekeywords=[1]{bne, beq, blt, bltu, bge, bgeu, jal, jalr, auipc, lb, lh, lw, ld, lbu, lhu, lwu, sb, sh, sw, sd, amoadd_w, amoxor_w, amoswap_w, amoand_w, amoor_w, amomin_w, amominu_w, amomax_w, amomaxu_w, amoadd_d, amoswap_d, amoxor_d, amoand_d, amoor_d, amomin_d, amominu_d, amomax_d, amomaxu_d, lr_w, lr_d, sc_w, sc_d, lui, addi, slti , sltiu, andi, ori, xori, slli, srli, srai, add, sub, slt, sltu, and, or, xor, sll, srl, sra, addiw, slliw, srliw, sraiw, addw, subw, sllw, srlw, sraw, mul, mulh, mulhu, mulhsu, mulw, div, divu, rem, remu, divw, divuw, remw, remuw, fence, fence_i, sfence_vm, scall, sbreak, sret, mrts, wfi, csrrw, csrrs, csrrc, csrrwi, csrrsi, csrrci
    }
    comment=[l]\#%
  }[keywords,comments,strings]

\lstdefinelanguage{lzero}{
  morestring=[b]",
  morekeywords=[1]{if,while,return,func,int,var,decl},
  comment=[l]{//}%
}[keywords,comments,strings]

\lstdefinelanguage{Rust}{%
  sensitive%
, morecomment=[l]{//}%
, morecomment=[s]{/*}{*/}%
, moredelim=[s][{\itshape\color[rgb]{0,0,0.75}}]{\#[}{]}%
, morestring=[b]{"}%
, alsodigit={}%
, alsoother={}%
, alsoletter={!}%
%
%
% [1] reserve keywords
% [2] traits
% [3] primitive types
% [4] type and value constructors
% [5] identifier
%
, morekeywords={break, continue, else, for, if, in, loop, match, return, while}  % control flow keywords
, morekeywords={as, const, let, move, mut, ref, static}  % in the context of variables
, morekeywords={dyn, enum, fn, impl, Self, self, struct, trait, type, union, use, where}  % in the context of declarations
, morekeywords={crate, extern, mod, pub, super}  % in the context of modularisation
, morekeywords={unsafe}  % markers
, morekeywords={abstract, alignof, become, box, do, final, macro, offsetof, override, priv, proc, pure, sizeof, typeof, unsized, virtual, yield}  % reserved identifiers
%
% grep 'pub trait [A-Za-z][A-Za-z0-9]*' -r . | sed 's/^.*pub trait \([A-Za-z][A-Za-z0-9]*\).*/\1/g' | sort -u | tr '\n' ',' | sed 's/^\(.*\),$/{\1}\n/g' | sed 's/,/, /g'
, morekeywords=[2]{Add, AddAssign, Any, AsciiExt, AsInner, AsInnerMut, AsMut, AsRawFd, AsRawHandle, AsRawSocket, AsRef, Binary, BitAnd, BitAndAssign, Bitor, BitOr, BitOrAssign, BitXor, BitXorAssign, Borrow, BorrowMut, Boxed, BoxPlace, BufRead, BuildHasher, CastInto, CharExt, Clone, CoerceUnsized, CommandExt, Copy, Debug, DecodableFloat, Default, Deref, DerefMut, DirBuilderExt, DirEntryExt, Display, Div, DivAssign, DoubleEndedIterator, DoubleEndedSearcher, Drop, EnvKey, Eq, Error, ExactSizeIterator, ExitStatusExt, Extend, FileExt, FileTypeExt, Float, Fn, FnBox, FnMut, FnOnce, Freeze, From, FromInner, FromIterator, FromRawFd, FromRawHandle, FromRawSocket, FromStr, FullOps, FusedIterator, Generator, Hash, Hasher, Index, IndexMut, InPlace, Int, Into, IntoCow, IntoInner, IntoIterator, IntoRawFd, IntoRawHandle, IntoRawSocket, IsMinusOne, IsZero, Iterator, JoinHandleExt, LargeInt, LowerExp, LowerHex, MetadataExt, Mul, MulAssign, Neg, Not, Octal, OpenOptionsExt, Ord, OsStrExt, OsStringExt, Packet, PartialEq, PartialOrd, Pattern, PermissionsExt, Place, Placer, Pointer, Product, Put, RangeArgument, RawFloat, Read, Rem, RemAssign, Seek, Shl, ShlAssign, Shr, ShrAssign, Sized, SliceConcatExt, SliceExt, SliceIndex, Stats, Step, StrExt, Sub, SubAssign, Sum, Sync, TDynBenchFn, Terminal, Termination, ToOwned, ToSocketAddrs, ToString, Try, TryFrom, TryInto, UnicodeStr, Unsize, UpperExp, UpperHex, WideInt, Write}
, morekeywords=[2]{Send}  % additional traits
%
, morekeywords=[3]{bool, char, f32, f64, i8, i16, i32, i64, isize, str, u8, u16, u32, u64, unit, usize, i128, u128}  % primitive types
%
, morekeywords=[4]{Err, false, None, Ok, Some, true}  % prelude value constructors
% grep 'pub \(type\|struct\|enum\) [A-Za-z][A-Za-z0-9]*' -r . | sed 's/^.*pub \(type\|struct\|enum\) \([A-Za-z][A-Za-z0-9]*\).*/\2/g' | sort -u | tr '\n' ',' | sed 's/^\(.*\),$/{\1}\n/g' | sed 's/,/, /g'
, morekeywords=[3]{AccessError, Adddf3, AddI128, AddoI128, AddoU128, ADDRESS, ADDRESS64, addrinfo, ADDRINFOA, AddrParseError, Addsf3, AddU128, advice, aiocb, Alignment, AllocErr, AnonPipe, Answer, Arc, Args, ArgsInnerDebug, ArgsOs, Argument, Arguments, ArgumentV1, Ashldi3, Ashlti3, Ashrdi3, Ashrti3, AssertParamIsClone, AssertParamIsCopy, AssertParamIsEq, AssertUnwindSafe, AtomicBool, AtomicPtr, Attr, auxtype, auxv, BackPlace, BacktraceContext, Barrier, BarrierWaitResult, Bencher, BenchMode, BenchSamples, BinaryHeap, BinaryHeapPlace, blkcnt, blkcnt64, blksize, BOOL, boolean, BOOLEAN, BoolTrie, BorrowError, BorrowMutError, Bound, Box, bpf, BTreeMap, BTreeSet, Bucket, BucketState, Buf, BufReader, BufWriter, Builder, BuildHasherDefault, BY, BYTE, Bytes, CannotReallocInPlace, cc, Cell, Chain, CHAR, CharIndices, CharPredicateSearcher, Chars, CharSearcher, CharsError, CharSliceSearcher, CharTryFromError, Child, ChildPipes, ChildStderr, ChildStdin, ChildStdio, ChildStdout, Chunks, ChunksMut, ciovec, clock, clockid, Cloned, cmsgcred, cmsghdr, CodePoint, Color, ColorConfig, Command, CommandEnv, Component, Components, CONDITION, condvar, Condvar, CONSOLE, CONTEXT, Count, Cow, cpu, CRITICAL, CStr, CString, CStringArray, Cursor, Cycle, CycleIter, daddr, DebugList, DebugMap, DebugSet, DebugStruct, DebugTuple, Decimal, Decoded, DecodeUtf16, DecodeUtf16Error, DecodeUtf8, DefaultEnvKey, DefaultHasher, dev, device, Difference, Digit32, DIR, DirBuilder, dircookie, dirent, dirent64, DirEntry, Discriminant, DISPATCHER, Display, Divdf3, Divdi3, Divmoddi4, Divmodsi4, Divsf3, Divsi3, Divti3, dl, Dl, Dlmalloc, Dns, DnsAnswer, DnsQuery, dqblk, Drain, DrainFilter, Dtor, Duration, DwarfReader, DWORD, DWORDLONG, DynamicLibrary, Edge, EHAction, EHContext, Elf32, Elf64, Empty, EmptyBucket, EncodeUtf16, EncodeWide, Entry, EntryPlace, Enumerate, Env, epoll, errno, Error, ErrorKind, EscapeDebug, EscapeDefault, EscapeUnicode, event, Event, eventrwflags, eventtype, ExactChunks, ExactChunksMut, EXCEPTION, Excess, ExchangeHeapSingleton, exit, exitcode, ExitStatus, Failure, fd, fdflags, fdsflags, fdstat, ff, fflags, File, FILE, FileAttr, filedelta, FileDesc, FilePermissions, filesize, filestat, FILETIME, filetype, FileType, Filter, FilterMap, Fixdfdi, Fixdfsi, Fixdfti, Fixsfdi, Fixsfsi, Fixsfti, Fixunsdfdi, Fixunsdfsi, Fixunsdfti, Fixunssfdi, Fixunssfsi, Fixunssfti, Flag, FlatMap, Floatdidf, FLOATING, Floatsidf, Floatsisf, Floattidf, Floattisf, Floatundidf, Floatunsidf, Floatunsisf, Floatuntidf, Floatuntisf, flock, ForceResult, FormatSpec, Formatted, Formatter, Fp, FpCategory, fpos, fpos64, fpreg, fpregset, FPUControlWord, Frame, FromBytesWithNulError, FromUtf16Error, FromUtf8Error, FrontPlace, fsblkcnt, fsfilcnt, fsflags, fsid, fstore, fsword, FullBucket, FullBucketMut, FullDecoded, Fuse, GapThenFull, GeneratorState, gid, glob, glob64, GlobalDlmalloc, greg, group, GROUP, Guard, GUID, Handle, HANDLE, Handler, HashMap, HashSet, Heap, HINSTANCE, HMODULE, hostent, HRESULT, id, idtype, if, ifaddrs, IMAGEHLP, Immut, in, in6, Incoming, Infallible, Initializer, ino, ino64, inode, input, InsertResult, Inspect, Instant, int16, int32, int64, int8, integer, IntermediateBox, Internal, Intersection, intmax, IntoInnerError, IntoIter, IntoStringError, intptr, InvalidSequence, iovec, ip, IpAddr, ipc, Ipv4Addr, ipv6, Ipv6Addr, Ipv6MulticastScope, Iter, IterMut, itimerspec, itimerval, jail, JoinHandle, JoinPathsError, KDHELP64, kevent, kevent64, key, Key, Keys, KV, l4, LARGE, lastlog, launchpad, Layout, Lazy, lconv, Leaf, LeafOrInternal, Lines, LinesAny, LineWriter, linger, linkcount, LinkedList, load, locale, LocalKey, LocalKeyState, Location, lock, LockResult, loff, LONG, lookup, lookupflags, LookupHost, LPBOOL, LPBY, LPBYTE, LPCSTR, LPCVOID, LPCWSTR, LPDWORD, LPFILETIME, LPHANDLE, LPOVERLAPPED, LPPROCESS, LPPROGRESS, LPSECURITY, LPSTARTUPINFO, LPSTR, LPVOID, LPWCH, LPWIN32, LPWSADATA, LPWSAPROTOCOL, LPWSTR, Lshrdi3, Lshrti3, lwpid, M128A, mach, major, Map, mcontext, Metadata, Metric, MetricMap, mflags, minor, mmsghdr, Moddi3, mode, Modsi3, Modti3, MonitorMsg, MOUNT, mprot, mq, mqd, msflags, msghdr, msginfo, msglen, msgqnum, msqid, Muldf3, Mulodi4, Mulosi4, Muloti4, Mulsf3, Multi3, Mut, Mutex, MutexGuard, MyCollection, n16, NamePadding, NativeLibBoilerplate, nfds, nl, nlink, NodeRef, NoneError, NonNull, NonZero, nthreads, NulError, OccupiedEntry, off, off64, oflags, Once, OnceState, OpenOptions, Option, Options, OptRes, Ordering, OsStr, OsString, Output, OVERLAPPED, Owned, Packet, PanicInfo, Param, ParseBoolError, ParseCharError, ParseError, ParseFloatError, ParseIntError, ParseResult, Part, passwd, Path, PathBuf, PCONDITION, PCONSOLE, Peekable, PeekMut, Permissions, PhantomData, pid, Pipes, PlaceBack, PlaceFront, PLARGE, PoisonError, pollfd, PopResult, port, Position, Powidf2, Powisf2, Prefix, PrefixComponent, PrintFormat, proc, Process, PROCESS, processentry, protoent, PSRWLOCK, pthread, ptr, ptrdiff, PVECTORED, Queue, radvisory, RandomState, Range, RangeFrom, RangeFull, RangeInclusive, RangeMut, RangeTo, RangeToInclusive, RawBucket, RawFd, RawHandle, RawPthread, RawSocket, RawTable, RawVec, Rc, ReadDir, Receiver, recv, RecvError, RecvTimeoutError, ReentrantMutex, ReentrantMutexGuard, Ref, RefCell, RefMut, REPARSE, Repeat, Result, Rev, Reverse, riflags, rights, rlim, rlim64, rlimit, rlimit64, roflags, Root, RSplit, RSplitMut, RSplitN, RSplitNMut, RUNTIME, rusage, RwLock, RWLock, RwLockReadGuard, RwLockWriteGuard, sa, SafeHash, Scan, sched, scope, sdflags, SearchResult, SearchStep, SECURITY, SeekFrom, segment, Select, SelectionResult, sem, sembuf, send, Sender, SendError, servent, sf, Shared, shmatt, shmid, ShortReader, ShouldPanic, Shutdown, siflags, sigaction, SigAction, sigevent, sighandler, siginfo, Sign, signal, signalfd, SignalToken, sigset, sigval, Sink, SipHasher, SipHasher13, SipHasher24, size, SIZE, Skip, SkipWhile, Slice, SmallBoolTrie, sockaddr, SOCKADDR, sockcred, Socket, SOCKET, SocketAddr, SocketAddrV4, SocketAddrV6, socklen, speed, Splice, Split, SplitMut, SplitN, SplitNMut, SplitPaths, SplitWhitespace, spwd, SRWLOCK, ssize, stack, STACKFRAME64, StartResult, STARTUPINFO, stat, Stat, stat64, statfs, statfs64, StaticKey, statvfs, StatVfs, statvfs64, Stderr, StderrLock, StderrTerminal, Stdin, StdinLock, Stdio, StdioPipes, Stdout, StdoutLock, StdoutTerminal, StepBy, String, StripPrefixError, StrSearcher, subclockflags, Subdf3, SubI128, SuboI128, SuboU128, subrwflags, subscription, Subsf3, SubU128, Summary, suseconds, SYMBOL, SYMBOLIC, SymmetricDifference, SyncSender, sysinfo, System, SystemTime, SystemTimeError, Take, TakeWhile, tcb, tcflag, TcpListener, TcpStream, TempDir, TermInfo, TerminfoTerminal, termios, termios2, TestDesc, TestDescAndFn, TestEvent, TestFn, TestName, TestOpts, TestResult, Thread, threadattr, threadentry, ThreadId, tid, time, time64, timespec, TimeSpec, timestamp, timeval, timeval32, timezone, tm, tms, ToLowercase, ToUppercase, TraitObject, TryFromIntError, TryFromSliceError, TryIter, TryLockError, TryLockResult, TryRecvError, TrySendError, TypeId, U64x2, ucontext, ucred, Udivdi3, Udivmoddi4, Udivmodsi4, Udivmodti4, Udivsi3, Udivti3, UdpSocket, uid, UINT, uint16, uint32, uint64, uint8, uintmax, uintptr, ulflags, ULONG, ULONGLONG, Umoddi3, Umodsi3, Umodti3, UnicodeVersion, Union, Unique, UnixDatagram, UnixListener, UnixStream, Unpacked, UnsafeCell, UNWIND, UpgradeResult, useconds, user, userdata, USHORT, Utf16Encoder, Utf8Error, Utf8Lossy, Utf8LossyChunk, Utf8LossyChunksIter, utimbuf, utmp, utmpx, utsname, uuid, VacantEntry, Values, ValuesMut, VarError, Variables, Vars, VarsOs, Vec, VecDeque, vm, Void, WaitTimeoutResult, WaitToken, wchar, WCHAR, Weak, whence, WIN32, WinConsole, Windows, WindowsEnvKey, winsize, WORD, Wrapping, wrlen, WSADATA, WSAPROTOCOL, WSAPROTOCOLCHAIN, Wtf8, Wtf8Buf, Wtf8CodePoints, xsw, xucred, Zip, zx}
%
, morekeywords=[5]{assert!, assert_eq!, assert_ne!, cfg!, column!, compile_error!, concat!, concat_idents!, debug_assert!, debug_assert_eq!, debug_assert_ne!, env!, eprint!, eprintln!, file!, format!, format_args!, include!, include_bytes!, include_str!, line!, module_path!, option_env!, panic!, print!, println!, select!, stringify!, thread_local!, try!, unimplemented!, unreachable!, vec!, write!, writeln!}  % prelude macros
}%

\lstdefinelanguage{JavaScript}{
  keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
  ndkeywords={class, export, boolean, throw, implements, import, this},
  sensitive=false,
  comment=[l]{//},
  morecomment=[s]{/*}{*/},
  morestring=[b]',
  morestring=[b]"
}

\lstloadlanguages{C,C++,Java,sh,[x86masm]Assembler,rust,JavaScript}
  \lstdefinestyle{basestyle}{
    basicstyle=\footnotesize\ttfamily,
    keywordstyle=\color{luhblue},
    commentstyle=\color{badbee!70!black},
    showstringspaces=false,
    breaklines=false,
    mathescape=true,
    lineskip=-2pt,
    escapechar={`},
    numbersep=1.5em,
    numberstyle=\tiny,
    showlines
  }
  \lstdefinestyle{smaller}{%
    basicstyle=\scriptsize\ttfamily,
  }
  \lstdefinestyle{C}{
    style=basestyle,
    language={C},
    morekeywords={inline},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{ada}{
    style=basestyle,
    language={ada},
    morekeywords={inline},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{rust}{
    style=basestyle,
    language={Rust},
    morekeywords={inline},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{ASM}{
    style=basestyle,
    mathescape=false,
    language={[riscv]Assembler},
    keywords={.macro, .endm},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{CPP}{
    style=basestyle,
    includerangemarker=false,
    language={C++},
    rangeprefix={//},
    morekeywords={string},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{py}{
    style=basestyle,
    language={python},
    includerangemarker=false,
    rangeprefix={\#},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{haskell}{
    style=basestyle,
    language={haskell},
    includerangemarker=false,
    rangeprefix={\#},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{java}{
    style=basestyle,
    language={java},
    includerangemarker=false,
    rangeprefix={\#},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{pascal}{
    style=basestyle,
    language={pascal},
    includerangemarker=false,
    rangeprefix={\#},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{text}{
    style=basestyle,
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{lzero}{
    style=basestyle,
    language={lzero},
    includerangemarker=false,
    rangeprefix={//},
    moredelim=**[is][\bfseries]{`}{`},
    moredelim=**[is][\slshape]{``}{``},
    moredelim=**[is][\btHL]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{srared}]{@@@}{@@@},
  }
  \lstdefinestyle{Java}{
    style=basestyle,
    language={Java},
    moredelim=**[is][\bfseries]{'}{'},
    moredelim=**[is][\slshape]{''}{''},
    moredelim=**[is][\lsthighlight]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{i4blue}]{@@@}{@@@},
  }

\lstdefinestyle{JS}{
    style=basestyle,
    language={javascript},
    moredelim=**[is][\bfseries]{'}{'},
    moredelim=**[is][\slshape]{''}{''},
    moredelim=**[is][\lsthighlight]{@}{@},
    moredelim=**[is][\color{orange}]{@@}{@@},
    moredelim=**[is][\color{i4blue}]{@@@}{@@@},
  }

\let\C=\relax

\newcommand{\addLangEnv}[1]{%
  \addLangEnvHelper#1\@nnil%
}
\def\addLangEnvHelper#1/#2\@nnil{%
  \lstnewenvironment{#1}[1][]{
    \lstset{style=#2, autogobble, ##1}
  } {}
}
\forcsvlist\addLangEnv{C/C,pascal/pascal,JS/JS}


\lstnewenvironment{haskell}[1][]{
  \lstset{style=haskell, autogobble, #1}
} {}

\lstnewenvironment{java}[1][]{
  \lstset{style=java, autogobble, #1}
} {}

\lstnewenvironment{ada}[1][]{
  \lstset{style=ada, autogobble, #1}
} {}

\lstnewenvironment{codetext}[1][]{
  \lstset{style=text, autogobble, #1}
} {}

\lstnewenvironment{rust}[1][]{
  \lstset{style=rust, autogobble, #1}
} {}


\lstnewenvironment{CPP}[1][]{
  \lstset{style=CPP, autogobble, #1}
} {}
\lstnewenvironment{py}[1][]{
  \lstset{style=py, autogobble, #1}
} {}
\lstnewenvironment{lzero}[1][]{
  \lstset{style=lzero, autogobble, #1}
} {}
\lstnewenvironment{asm}[1][]{
  \lstset{style=ASM, autogobble, #1}
} {}

  % set default for \lstinline
  \lstset{style=C, basicstyle=\scriptsize\ttfamily, keywordstyle={}}

  \lstdefinestyle{highlighting}{
    moredelim=**[is][\btHL<1>]{@1}{@},
    moredelim=**[is][\btHL<2>]{@2}{@},
    moredelim=**[is][\btHL<3>]{@3}{@},
    moredelim=**[is][\btHL<4>]{@4}{@},
    moredelim=**[is][\btHL<5>]{@5}{@},
    moredelim=**[is][\btHL<6>]{@6}{@},
    moredelim=**[is][\btHL<7>]{@7}{@},
    moredelim=**[is][\btHL<8>]{@8}{@},
    moredelim=**[is][\btHL<9>]{@9}{@},
    moredelim=**[is][\btHL<1->]{@+1}{@},
    moredelim=**[is][\btHL<2->]{@+2}{@},
    moredelim=**[is][\btHL<3->]{@+3}{@},
    moredelim=**[is][\btHL<4->]{@+4}{@},
    moredelim=**[is][\btHL<5->]{@+5}{@},
    moredelim=**[is][\btHL<6->]{@+6}{@},
    moredelim=**[is][\btHL<7->]{@+7}{@},
    moredelim=**[is][\btHL<8->]{@+8}{@},
    moredelim=**[is][\btHL<9->]{@+9}{@},
 }

  % Makros to underbrace/overbrace elements in listings
  %
  % \lstub<overlay spec>{stuff}{brace comment}
  % \lstob<overlay spec>{stuff}{brace comment}
  %
  %
  \newcommand<>{\lstub}[2]{\ensuremath{%
    \underset{%
      \onslide#3{\text{#1}}
    }{%
      {\only#3\underbrace{
        \text{#2}
      }}
    }
  }}
  \newcommand<>{\lstob}[2]{\ensuremath{%
    \overset{%
      \onslide#3{\text{#1}}
    }{%
      {\only#3\overbrace{
        \text{#2}
      }}
    }
  }}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Misc
\usepackage{convention} % texmf-local
\newcommand{\advantage}[1]{\bgroup\color{safegreen}#1{\egroup}}
\newcommand{\dn}[2][]{\tikz[baseline]\node[anchor=base,circle,inner sep=1pt,draw,#1]{#2};}
\renewcommand{\iiad}{\ii[\color{safegreen}\textbf{+}]}  % advantage
\renewcommand{\iida}{\ii[\color{safered}\textbf{--}]} % disadvantage
\newcommand{\lecturetag}[3][]{%
  \tikz[baseline]\node[anchor=base,draw=black,fill=#2color,#1]{\color{black}Vorlesung #3};
}

\newcommand{\dividerframe}[1]{
  \begin{frame}<handout:0>[noframenumbering]
    \begin{center}
      \Huge #1
    \end{center}
  \end{frame}
}

\usepackage{fig/03-common}
\usepackage{fig/04-common}


\newcommand{\tikznode}[2][]{%
  \tikz[baseline]\node[anchor=base,#1]{#2};%
}

\newsavebox{\@overlaybox}
\newenvironment<>{overlaybox}[1][]{%
  % We set the overlay tikz node in the next shipout routine.
  % Thereby, we do not produce a \leavemode after the lrbox
  \only#2{%
    \AtBeginShipoutNext{%
      \AtBeginShipoutUpperLeftForeground{%
        \begin{tikzpicture}[remember picture, overlay]%
          \node[fill=white,draw] at (current page.center) [#1] {\usebox{\@overlaybox}};
        \end{tikzpicture}%
      }%
    }%
  }%
  % Produce the @conclusionoverlay
  \setbox\@overlaybox=\vbox\bgroup%
}{%
  \egroup%
  \global\setbox\@overlaybox=\copy\@overlaybox\relax%
}
