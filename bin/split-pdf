#!/usr/bin/python3

import sys
import subprocess
import os.path
from common import normalize_topic

if __name__ == '__main__':
    if len(sys.argv) != 3:
        print(f"usage: {sys.argv[0]} [PDF] [TOPIC-FILE]")

    pdf = sys.argv[1]
    pdf_base, _ = os.path.splitext(pdf)
    with open(sys.argv[2]) as fd:
        for line in fd.readlines():
            pages, lines, topic = line.strip().split(":", 2)
            topic = normalize_topic(topic)
            split = ["pdftk", pdf, "cat", pages, "output", f"{pdf_base}-{topic}-{lines}.pdf", "dont_ask"]
            print(" ".join(split))
            subprocess.check_call(split)

            convert = ["convert",
                       "-density", "400",
                       f"{pdf_base}-{topic}-{lines}.pdf",
                       "-quality", "100",
                       "-sharpen", "0x1.0",
                       f"{os.path.dirname(pdf_base)}/html/{os.path.basename(pdf_base)}-{topic}-{lines}-%04d.png"
            ]
            # Use SVG
            convert = ["pdf2svg",
                       f"{pdf_base}-{topic}-{lines}.pdf",
                       f"{os.path.dirname(pdf_base)}/html/{os.path.basename(pdf_base)}-{topic}-{lines}-%04d.svg",
                       "all"]
            print(" ".join(convert))
            subprocess.check_call(convert)
