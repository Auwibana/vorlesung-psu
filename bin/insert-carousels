#!/usr/bin/python3

import sys
import os
import glob

def make_carousel(topic, files):
    print('<div class="content">')
    print('<div class="container">')
    print('<div id="slides-' + topic +'" class="carousel" data-wrap="false" data-interval="0" data-ride="carousel">')
    print('<ol class="carousel-indicators">')
    print('<li data-target="#slides-'+ topic + '" data-slide-to="0" class="active"></li>')
    for i in range(1, len(files)):
        print('<li data-target="#slides-'+topic+'" data-slide-to="'+str(i)+'"></li>')
    print('</ol>')
    print('<div class="carousel-inner">')
    active="active"
    for fn in files:
        print('<div class="carousel-item '+ active + '">')
        print('   <img class="d-block w-100"  href="#slides-'+topic+'" role="button" data-slide="next" src="'+fn+'"/>')
        print('</div>')
        active=''
    print('</div>')
    print('<a class="carousel-control-prev" href="#slides-'+topic+'" role="button" data-slide="prev">')
    print('<span class="carousel-control-prev-icon" aria-hidden="true"></span>')
    print('<span class="sr-only">Previous</span>')
    print('</a>')
    print('<a class="carousel-control-next" href="#slides-'+topic+'" role="button" data-slide="next">')
    print('<span class="carousel-control-next-icon" aria-hidden="true"></span>')
    print('<span class="sr-only">Next</span>')
    print('</a>')
    print('</div>')



if __name__ == "__main__":
    if len(sys.argv) != 3:
        print(f"usage: {sys.argv[0]} [HTML] [TOPIC-FILE]")

    html, topics = sys.argv[1:]
    with open(topics) as fd:
        topics = {}
        for _, topic in [x.strip().split(":", 1) for x in fd.readlines()]:
            basename = os.path.basename(html)
            base,_ = os.path.splitext(basename)
            pattern = f"build/html/{base}-{topic}-*.png"
            topics[topic] = [os.path.basename(x) for x in sorted(glob.glob(pattern))]


    with open(html) as fd:
        lines = iter(fd.readlines())
        for line in lines:
            sys.stdout.write(line)
            found,files = None, None
            for topic in topics:
                if line.startswith("<h") and topic+"</h" in line:
                    found,files = topic,topics[topic]
                    del topics[topic]
                    break
            if found:
                make_carousel(found, files)
